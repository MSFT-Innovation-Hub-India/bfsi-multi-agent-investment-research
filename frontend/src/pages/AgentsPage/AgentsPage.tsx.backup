import { useState, useEffect } from 'react'
import Tabs from '../../components/Tabs/Tabs'
import OutputSection from '../../components/OutputSection/OutputSection'
import JsonViewer from '../../components/JsonViewer/JsonViewer'
import { AgentView, SectionOutput } from '../../types/models'

function AgentsPage() {
  const [activeAgent, setActiveAgent] = useState('stock')
  const [activeStockTab, setActiveStockTab] = useState('executive_summary')
  const [activeInvestmentTab, setActiveInvestmentTab] = useState('executive_summary')
  const [activeComplianceTab, setActiveComplianceTab] = useState('policy')
  const [showJson, setShowJson] = useState(false)
  const [stockData, setStockData] = useState<any>(null)
  const [investmentData, setInvestmentData] = useState<any>(null)
  const [complianceFindings, setComplianceFindings] = useState<any>(null)
  const [complianceRecommendation, setComplianceRecommendation] = useState<any>(null)

  useEffect(() => {
    // Load all JSON data from public folder
    fetch('/data/stock_report.json')
      .then(r => r.json())
      .then(data => setStockData(data))
      .catch(err => console.error('Error loading stock data:', err))

    fetch('/data/company_analysis_output.json')
      .then(r => r.json())
      .then(data => setInvestmentData(data))
      .catch(err => console.error('Error loading investment data:', err))

    fetch('/data/compliance_findings.json')
      .then(r => r.json())
      .then(data => setComplianceFindings(data))
      .catch(err => console.error('Error loading compliance findings:', err))

    fetch('/data/compliance_recommendation.json')
      .then(r => r.json())
      .then(data => setComplianceRecommendation(data))
      .catch(err => console.error('Error loading compliance recommendation:', err))
  }, [])

  // Build Stock Analysis sections from loaded data
  const buildStockSections = (): Record<string, SectionOutput> => {
    if (!stockData?.sections) return {}
    
    const sections: Record<string, SectionOutput> = {}
    stockData.sections.forEach((section: any) => {
      const sectionId = section.id.replace('panel_', '').replace('_', '')
      sections[section.id] = {
        id: section.id,
        title: section.name,
        summary: section.summary,
        image: section.image ? {
          id: section.id,
          src: `/images/${section.image}`,
          alt: section.name
        } : undefined,
        rawJson: section
      }
    })
    return sections
  }

  const stockSections = buildStockSections()

  // Keep old structure for backwards compatibility
  const stockSectionsCompat: Record<string, SectionOutput> = {
    executive_summary: stockSections['executive_summary'] || {
      id: 'executive_summary',
      title: 'Executive Summary',
      summary: 'Loading...',
      rawJson: {}
    },
    p1: {
      id: 'p1',
      title: 'P1: Price Trend Analysis',
      summary: 'Price trend shows steady upward momentum over the 30-day period with significant volume spikes coinciding with price increases.',
      image: { id: 'p1', src: '/assets/images/p1_price_trend.png', alt: 'Price Trend Chart' },
      rawJson: { id: 'panel_p1_price_trend', image: 'p1_price_trend.png' }
    },
    p2: {
      id: 'p2',
      title: 'P2: Relative Performance',
      summary: 'GMR Infrastructure has outperformed the Nifty 50 index by 2.3% during this period, showing strong relative strength.',
      image: { id: 'p2', src: '/assets/images/p2_relative_perf.png', alt: 'Relative Performance Chart' },
      rawJson: { id: 'panel_p2_relative_perf', image: 'p2_relative_perf.png' }
    },
    p3: {
      id: 'p3',
      title: 'P3: Liquidity Analysis',
      summary: 'Average daily traded value of ₹223.5 Cr demonstrates strong liquidity with low bid-ask spreads.',
      image: { id: 'p3', src: '/assets/images/p3_liquidity.png', alt: 'Liquidity Chart' },
      rawJson: { id: 'panel_p3_liquidity', image: 'p3_liquidity.png' }
    },
    p4: {
      id: 'p4',
      title: 'P4: Volatility Analysis',
      summary: 'Volatility of 13.98% is moderate for infrastructure sector stocks, indicating manageable risk levels.',
      image: { id: 'p4', src: '/assets/images/p4_volatility.png', alt: 'Volatility Chart' },
      rawJson: { id: 'panel_p4_volatility', image: 'p4_volatility.png' }
    }
  }

  // Investment Analysis Agent Data
  const investmentSections: Record<string, SectionOutput> = {
    executive: {
      id: 'executive',
      title: 'Executive Summary',
      analysis: 'GMR Infrastructure shows mixed financial performance with revenue growth offset by persistent losses. Strong airport assets provide long-term value but current valuation metrics are stretched.',
      rawJson: { id: 'executive_summary', analysis: 'Mixed performance with strong assets' }
    },
    financial: {
      id: 'financial',
      title: 'Financial Performance',
      analysis: 'Revenue increased from ₹12.63 Bn to ₹14.10 Bn (11.6% growth). EBITDA margin improved to 7.09% from 5.52%. However, net loss persists at -₹3.15 Bn.',
      rawJson: { id: 'financial_performance', analysis: 'Revenue ₹14.10 Bn, EBITDA 7.09%', dashboard: 'financial_overview' }
    },
    balance: {
      id: 'balance',
      title: 'Balance Sheet & Debt Analysis',
      analysis: 'Total debt stands at ₹243 Bn with Debt/Equity ratio of 2.8x. Interest coverage improved but remains weak at 1.2x.',
      rawJson: { id: 'balance_debt', analysis: 'Debt ₹243 Bn, D/E 2.8x', dashboard: 'debt_liquidity' }
    },
    operational: {
      id: 'operational',
      title: 'Operational Performance',
      analysis: 'Airport passenger traffic recovered to 95% of pre-pandemic levels. Delhi and Hyderabad airports showing strong operational metrics.',
      rawJson: { id: 'operational_performance', analysis: 'Traffic recovery at 95%', dashboard: 'operations_capacity' }
    },
    projects: {
      id: 'projects',
      title: 'Projects & Funding',
      analysis: 'Multiple expansion projects underway with ₹35 Bn capital allocation. Funding mix includes internal accruals and strategic partnerships.',
      rawJson: { id: 'projects_funding', analysis: 'Capex ₹35 Bn for expansions', dashboard: 'projects_funding' }
    },
    valuation: {
      id: 'valuation',
      title: 'Valuation & Risk Assessment',
      analysis: 'EV/EBITDA of 177x is significantly above sector average. Price-to-Book of 3.2x reflects premium for airport assets but raises concerns about entry point.',
      rawJson: { id: 'valuation_risk', analysis: 'EV/EBITDA 177x, P/B 3.2x', dashboard: 'valuation_risk' }
    },
    strengths: {
      id: 'strengths',
      title: 'Key Strengths',
      points: [
        'India\'s aviation growth potential with rising middle class',
        'Strong airport portfolio (Delhi, Hyderabad, Goa)',
        'Improving operational metrics post-pandemic',
        'Strategic partnerships with global airport operators'
      ],
      rawJson: { key_strengths: ['Aviation growth', 'Strong portfolio', 'Operational improvement', 'Strategic partnerships'] }
    },
    challenges: {
      id: 'challenges',
      title: 'Key Challenges',
      points: [
        'Negative profitability with recurring losses',
        'High debt burden affecting financial flexibility',
        'Stretched valuation metrics (EV/EBITDA 177x)',
        'Regulatory risks in airport sector'
      ],
      rawJson: { key_challenges: ['Losses', 'High debt', 'Stretched valuation', 'Regulatory risks'] }
    }
  }

  // Compliance Evaluation Agent Data
  const complianceSections: Record<string, SectionOutput> = {
    policy: {
      id: 'policy',
      title: 'Section 1: Policy Rules Compliance',
      analysis: 'Stock meets minimum listing requirements with 10+ years on NSE. Market cap of ₹37,850 Cr exceeds minimum threshold. Float is adequate at 62% of shares.',
      rawJson: { section_1_policy_rules: 'Meets listing requirements, adequate float' }
    },
    trading: {
      id: 'trading',
      title: 'Section 2: Trading Classification',
      analysis: 'Traded value: ₹6,688.08 Cr over 30 days. Volume: 56 million shares. Average daily value: ₹223.5 Cr classifies as "Actively Traded" per institutional guidelines.',
      rawJson: { section_2_trading_classification: 'Actively Traded, ₹6,688 Cr value' }
    },
    events: {
      id: 'events',
      title: 'Section 3: Exceptional Events',
      analysis: 'Recent corporate action: Rights issue announced for ₹8,000 Cr. Insider trading: 2 promoter transactions in last quarter. These require additional disclosure in investment proposal.',
      rawJson: { section_3_exceptional_events: 'Rights issue ₹8,000 Cr, promoter trades' }
    },
    verdict: {
      id: 'verdict',
      title: 'Section 4: Final Compliance Verdict',
      analysis: 'FINAL COMPLIANCE VERDICT: REVIEW REQUIRED\n\nRationale: While stock meets basic compliance criteria, the announced rights issue and recent promoter transactions necessitate additional due diligence before investment approval.',
      rawJson: { section_4_final_recommendation: 'REVIEW REQUIRED due to rights issue and promoter transactions' }
    }
  }

  const agentTabs = [
    { id: 'stock', label: 'Stock Analyst' },
    { id: 'investment', label: 'Investment Analyst' },
    { id: 'compliance', label: 'Compliance Evaluator' }
  ]

  const stockTabs = [
    { id: 'executive', label: 'Executive Summary' },
    { id: 'p1', label: 'P1: Price Trend' },
    { id: 'p2', label: 'P2: Relative Performance' },
    { id: 'p3', label: 'P3: Liquidity' },
    { id: 'p4', label: 'P4: Volatility' }
  ]

  const investmentTabs = [
    { id: 'executive', label: 'Executive Summary' },
    { id: 'financial', label: 'Financial Performance' },
    { id: 'balance', label: 'Balance Sheet & Debt' },
    { id: 'operational', label: 'Operational Performance' },
    { id: 'projects', label: 'Projects & Funding' },
    { id: 'valuation', label: 'Valuation & Risk' },
    { id: 'strengths', label: 'Key Strengths' },
    { id: 'challenges', label: 'Key Challenges' }
  ]

  const complianceTabs = [
    { id: 'policy', label: 'Policy Rules' },
    { id: 'trading', label: 'Trading Classification' },
    { id: 'events', label: 'Exceptional Events' },
    { id: 'verdict', label: 'Final Verdict' }
  ]

  return (
    <div className="max-w-7xl mx-auto">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-3xl font-bold text-primary-900">Agent Outputs</h1>
        <button
          onClick={() => setShowJson(!showJson)}
          className="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors"
        >
          {showJson ? 'Hide' : 'Show'} JSON
        </button>
      </div>

      {/* Agent Selection Tabs */}
      <Tabs tabs={agentTabs} activeTab={activeAgent} onTabChange={setActiveAgent} variant="primary" />

      <div className="mt-6">
        {/* Stock Analyst View */}
        {activeAgent === 'stock' && (
          <div className="space-y-6">
            <Tabs tabs={stockTabs} activeTab={activeStockTab} onTabChange={setActiveStockTab} variant="secondary" />
            <OutputSection section={stockSections[activeStockTab]} showJson={showJson} />
          </div>
        )}

        {/* Investment Analyst View */}
        {activeAgent === 'investment' && (
          <div className="space-y-6">
            <Tabs tabs={investmentTabs} activeTab={activeInvestmentTab} onTabChange={setActiveInvestmentTab} variant="secondary" />
            <OutputSection section={investmentSections[activeInvestmentTab]} showJson={showJson} />
          </div>
        )}

        {/* Compliance Evaluator View */}
        {activeAgent === 'compliance' && (
          <div className="space-y-6">
            <Tabs tabs={complianceTabs} activeTab={activeComplianceTab} onTabChange={setActiveComplianceTab} variant="secondary" />
            <OutputSection section={complianceSections[activeComplianceTab]} showJson={showJson} />
          </div>
        )}
      </div>
    </div>
  )
}

export default AgentsPage
